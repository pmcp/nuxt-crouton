---
title: Team-Based Authentication
description: Scope data and API calls to specific teams
icon: i-heroicons-user-group
---

Team-based authentication is built into Nuxt Crouton, automatically scoping all data and API calls to the current team context.

## How It Works

All generated collections are team-scoped by default:

1. **Database fields** are automatically added:
   - `teamId` (text, required) - References the team/organization
   - `userId` (text, required) - References the user who created the record

2. **API endpoints** automatically:
   - Inject `teamId` and `userId` from the authenticated session
   - Include team membership validation via `resolveTeamAndCheckMembership`
   - Scope all database queries to the current user's team

3. **Client-side queries** automatically:
   - Include the current team ID in API calls
   - Filter results by team
   - Invalidate when team changes

::callout{icon="i-heroicons-exclamation-triangle" color="amber"}
**Important:** Do NOT manually define `teamId` or `userId` in your schema JSON files. The generator adds these automatically, and manual definitions will cause duplicate key errors.

See [Schema Format - Auto-Generated Fields](/generation/schema-format#auto-generated-fields) for details.
::

## Requirements

Team authentication requires `@crouton/auth`:

```bash
pnpm add @crouton/auth
```

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  extends: [
    '@fyit/crouton',
    '@crouton/auth'
  ]
})
```

## Client-Side Usage

Use `useTeamContext()` to access the current team:

```vue
<script setup lang="ts">
const { teamId, teamSlug } = useTeamContext()

// All API calls include team context
const { items } = await useCollectionQuery('shopProducts')
// â†’ Fetches /api/teams/[teamId]/shop-products
</script>
```

::callout{type="tip" icon="i-heroicons-book-open"}
**Query Examples**: For complete `useCollectionQuery` patterns, see [Querying Data](/fundamentals/querying).
::

## Server-Side Usage

Generated API endpoints use `@crouton/auth/server` for team authentication:

```typescript
// Generated: server/api/teams/[team]/shop-products/index.get.ts
import { resolveTeamAndCheckMembership } from '@crouton/auth/server'

export default defineEventHandler(async (event) => {
  const { team, user } = await resolveTeamAndCheckMembership(event)

  // Query scoped to team
  const products = await db
    .select()
    .from(shopProducts)
    .where(eq(shopProducts.teamId, team.id))

  return products
})
```

## API Routes

Team-scoped API routes follow the pattern:

```
/api/teams/[team]/{layer}-{collection}/
```

For example:
- `/api/teams/abc123/shop-products/` - List products for team
- `/api/teams/abc123/shop-products/xyz789` - Get/update/delete specific product

## Team Switching

Allow users to switch between teams with automatic query refetching:

```vue
<script setup lang="ts">
const { currentTeam, teams, switchTeam } = useTeam()

const handleSwitchTeam = async (teamId: string) => {
  await switchTeam(teamId)
  // All queries auto-refetch for new team!
}
</script>

<template>
  <USelectMenu
    v-model="currentTeam"
    :options="teams"
    @update:model-value="handleSwitchTeam"
  />
</template>
```

## How Team Context Flows

1. User authenticates via `@crouton/auth`
2. Team is resolved from route parameter `[team]`
3. Membership is validated against the user's session
4. `teamId` is injected into all queries and mutations
5. Switching teams invalidates and refetches all queries

## Related Sections

- [Querying Data](/fundamentals/querying) - Query patterns
- [Caching](/fundamentals/caching) - Cache invalidation
- [Data Operations](/fundamentals/data-operations) - CRUD operations
- [Migration Guide](/guides/migration) - Migrating from older versions
