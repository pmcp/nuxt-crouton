# CLAUDE.md - @fyit/crouton

## Package Purpose

Core CRUD layer for Nuxt applications. Provides composables, components, and server utilities for building data-driven admin panels with team-scoped access, nested forms, and smart caching.

**Single-install experience:** Installing `@fyit/crouton` automatically includes i18n, auth, and admin packages - no need to install them separately.

## Auto-Included Packages

When you extend `nuxt-crouton`, you automatically get:

| Package | Provides | Routes |
|---------|----------|--------|
| `@nuxthub/core` | Database (D1/SQLite), KV storage, blob storage, multi-vendor support | None |
| `nuxt-crouton-i18n` | Translation system (`useT`), DB-backed translations, team overrides | None |
| `nuxt-crouton-auth` | Authentication, teams, sessions, OAuth, passkeys, 2FA | `/auth/*` |
| `nuxt-crouton-admin` | Super admin dashboard, user/team management, impersonation | `/super-admin/*` |

**Order matters:** NuxtHub loads first (provides database), then i18n (provides translations), then auth (uses both), then admin (uses all).

### Simplified Setup

```typescript
// nuxt.config.ts - BEFORE (manual)
export default defineNuxtConfig({
  extends: [
    '@fyit/crouton',
    '@fyit/crouton-auth',
    '@fyit/crouton-admin',
    '@fyit/crouton-i18n',
    '@fyit/crouton-bookings',
  ]
})

// nuxt.config.ts - AFTER (auto-included)
export default defineNuxtConfig({
  extends: [
    '@fyit/crouton',           // Includes auth, admin, i18n
    '@fyit/crouton-bookings',       // Optional apps
  ]
})

## Key Files

| File | Purpose |
|------|---------|
| `app/composables/useCrouton.ts` | Modal/slideover state management (nested up to 5 levels) |
| `app/composables/useCollectionQuery.ts` | Async data fetching with query-based caching |
| `app/composables/useCollectionMutation.ts` | Create/update/delete with auto cache invalidation |
| `app/composables/useCollections.ts` | Collection config registry from `app.config.croutonCollections` |
| `app/composables/useCroutonShortcuts.ts` | Keyboard shortcuts for CRUD operations |
| `app/composables/useCollectionExport.ts` | CSV/JSON export for collection data |
| `app/components/Collection.vue` | Multi-layout display (table, list, grid, tree, kanban) |
| `app/components/Form.vue` | Main CRUD form handler with nested modal support |
| `app/components/ShortcutHint.vue` | Visual keyboard shortcut badges (`<kbd>` elements) |
| `app/components/ExportButton.vue` | Ready-to-use export dropdown button |
| `app/composables/useTeamContext.ts` | Team context access (teamId, teamSlug from route or auth) |

## Architecture

```
useCrouton()          → Modal state (open/close/nesting)
useCollectionQuery()  → Data fetching (SSR-safe, cached)
useCollectionMutation() → CRUD operations (auto-refresh cache)
useCollections()      → Config registry (componentMap, apiPath, references)
useCroutonShortcuts() → Keyboard shortcuts (create, save, close, delete, search)
useTeamContext()      → Team ID/slug from route params (client-side)
```

## Team Authentication

Team auth is provided by `@crouton/auth` (Better Auth with organization mode):

- **Client-side**: Use `useTeamContext()` composable for `teamId` and `teamSlug`
- **Server-side**: Use `@crouton/auth/server` utilities (e.g., `resolveTeamAndCheckMembership`)
- **Generated APIs**: Import from `@crouton/auth/server` (auto-generated by collection generator)

## Component Naming

All components auto-import with `Crouton` prefix:
- `Form.vue` → `<CroutonForm />`
- `Collection.vue` → `<CroutonCollection />`
- `Table.vue` → `<CroutonTable />`

## Collection Config Pattern

```typescript
// app.config.ts
export default defineAppConfig({
  croutonCollections: {
    products: {
      layer: 'shop',
      apiPath: '/api/teams/{teamId}/products',
      references: { categoryId: 'categories' }, // Auto-refresh on mutation
      dependentFieldComponents: { slots: 'SlotPicker' }
    }
  }
})
```

## API Patterns

- **Team-scoped**: `/api/teams/[id]/{collection}/*`
- **Super admin**: `/api/super-admin/{collection}/*`
- **Fetch strategies**: `?ids=` (query) or `/{id}` (RESTful)

## Cache Keys

```
collection:{name}:{queryJSON}     # List queries
collection-item:{name}:{id}       # Single items
```

Mutations invalidate ALL cache keys for the collection.

## Hooks

```typescript
// Listen for mutations (for event tracking)
useNuxtApp().hook('crouton:mutation', ({ operation, collection, itemId, data }) => {
  // operation: 'create' | 'update' | 'delete' | 'move' | 'reorder'
})
```

## Keyboard Shortcuts

Power-user keyboard shortcuts via `useCroutonShortcuts()`:

| Action | Mac | Windows | Context |
|--------|-----|---------|---------|
| Create | `⌘N` | `Ctrl+N` | When no form open |
| Save | `⌘S` | `Ctrl+S` | When form open |
| Close | `Esc` | `Esc` | Closes form/modal |
| Delete | `⌘⌫` | `Ctrl+Backspace` | With selection |
| Search | `⌘K` or `/` | `Ctrl+K` or `/` | Focus search |

```typescript
// Basic usage
const searchRef = ref<HTMLInputElement | null>(null)
const selected = ref<string[]>([])

const { formatShortcut } = useCroutonShortcuts({
  collection: 'posts',
  selected,
  searchRef,
  handlers: {
    onSave: () => formRef.value?.submit(),
    onDelete: (ids) => confirmDelete(ids),
  }
})

// Display shortcut hints
<UButton>New <CroutonShortcutHint :shortcut="formatShortcut('create')" subtle /></UButton>
```

## Common Tasks

### Add a new composable
1. Create file in `app/composables/use{Name}.ts`
2. Export function with `use` prefix
3. Auto-imported globally

### Add a new component
1. Create file in `app/components/{Name}.vue`
2. Use `<script setup lang="ts">`
3. Auto-imports as `Crouton{Name}`

### Modify team-auth logic
1. Team auth is now in `@crouton/auth` package
2. Client-side: `useTeamContext()` in this package (gets teamId/teamSlug from route)
3. Server-side: Import from `@crouton/auth/server` (e.g., `resolveTeamAndCheckMembership`)
4. See `packages/nuxt-crouton-auth/CLAUDE.md` for server utilities

### Add collection config option
1. Edit types in `app/composables/useCollections.ts`
2. Handle new option in relevant composables
3. Update type exports

## Dependencies

- **Auto-includes**: `@nuxthub/core`, `@nuxt/ui`, `nuxt-crouton-i18n`, `nuxt-crouton-auth`, `nuxt-crouton-admin`
- **Runtime deps**: `@libsql/client` (required for SQLite - pnpm doesn't hoist from layers)
- **Required by**: App packages (e.g., `crouton-bookings`)
- **Peer deps**: `nuxt ^4.0.0`

## NuxtHub Configuration

The core package includes `@nuxthub/core` with sensible defaults:

```typescript
// Default hub config (can be overridden in your app)
hub: {
  db: 'sqlite'  // Uses D1 on Cloudflare, local SQLite in dev
}
```

**Override in your app** to use different providers or add features:

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  extends: ['@fyit/crouton'],

  // Override or extend hub config
  hub: {
    db: 'postgresql',  // Use PostgreSQL instead
    kv: true,          // Enable KV storage
    blob: true         // Enable blob storage
  }
})
```

**Deployment**: NuxtHub is multi-vendor - deploy to Cloudflare Workers, Vercel, or any supported provider. See [NuxtHub docs](https://hub.nuxt.com/docs/getting-started/deploy) for deployment options.

## Type Definitions

```typescript
// Key types from app/types/table.ts
type LayoutType = 'table' | 'list' | 'grid' | 'tree' | 'kanban'
type GridSize = 'compact' | 'comfortable' | 'spacious'
interface PaginationData { currentPage, pageSize, totalItems, sortBy, sortDirection }
interface HierarchyConfig { enabled, parentField?, orderField?, pathField? }
```

## Testing

```bash
npx nuxt typecheck  # MANDATORY after changes
pnpm build          # Verify build works
```
