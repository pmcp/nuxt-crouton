/**
 * Manifest Injection Module
 *
 * Discovers crouton.manifest.ts files from all packages and injects
 * the merged registry into appConfig.crouton for runtime access.
 *
 * Consumers use useAppConfig().crouton.fieldTypes, .reservedFieldNames, etc.
 */
import { defineNuxtModule } from '@nuxt/kit'

export default defineNuxtModule({
  meta: {
    name: 'crouton-manifest-injection',
  },
  async setup(_options, nuxt) {
    try {
      const {
        discoverManifests,
        getFieldTypeRegistry,
        getAutoGeneratedFields,
        getReservedFieldNames,
        getReservedCollectionNames,
        getModuleRegistry,
      } = await import('@fyit/crouton-cli/lib/utils/manifest-loader')

      const manifests = await discoverManifests(nuxt.options.rootDir)

      const existing = (nuxt.options.appConfig.crouton ?? {}) as Record<string, unknown>
      nuxt.options.appConfig.crouton = {
        ...existing,
        fieldTypes: getFieldTypeRegistry(manifests),
        autoGeneratedFields: getAutoGeneratedFields(manifests),
        reservedFieldNames: getReservedFieldNames(manifests),
        reservedCollectionNames: getReservedCollectionNames(manifests),
        modules: getModuleRegistry(manifests),
      }

      console.log(`üçû crouton:core Loaded ${manifests.length} package manifests into app.config`)
    }
    catch {
      // Manifest loader not available (e.g., CLI not installed in production)
      if (process.env.DEBUG) {
        console.warn('üçû crouton:core Manifest injection skipped (crouton-cli not available)')
      }
    }
  },
})
