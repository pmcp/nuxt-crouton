// Generator for TypeScript types

/**
 * Generate AI context header for types files
 */
function generateAIHeader(data) {
  const { plural, layer, layerPascalCase, pascalCase, pascalCasePlural, fields } = data
  const prefixedPascalCase = `${layerPascalCase}${pascalCase}`
  const fieldNames = fields.map(f => f.name).join(', ')

  return `/**
 * @crouton-generated
 * @collection ${plural}
 * @layer ${layer}
 * @generated ${new Date().toISOString().split('T')[0]}
 *
 * ## AI Context
 * - Main interface: ${prefixedPascalCase}
 * - Form data type: ${prefixedPascalCase}FormData
 * - New item type: New${prefixedPascalCase}
 * - Form props: ${prefixedPascalCase}FormProps
 * - Fields: ${fieldNames}
 *
 * ## Common Modifications
 * - Add field: Add to interface and ensure schema matches
 * - Change field type: Update both interface and schema
 * - Add computed field: Add optional property to interface
 *
 * This file was generated by @friendlyinternet/nuxt-crouton-cli
 * Safe to modify - regeneration requires --force flag
 */

`
}

export function generateTypes(data, config = null) {
  const { pascalCase, pascalCasePlural, layerPascalCase, singular, layer, plural, fields } = data
  const prefixedPascalCase = `${layerPascalCase}${pascalCase}`
  const prefixedPascalCasePlural = `${layerPascalCase}${pascalCasePlural}`
  const prefixedSingular = `${layerPascalCase.toLowerCase()}${pascalCase}`

  const composablePath = `./app/composables/use${prefixedPascalCasePlural}`

  // Conditional field generation based on config flags
  // Team fields are always required (all generated endpoints use @crouton/auth)
  const useMetadata = config?.flags?.useMetadata ?? true

  // Team fields are always included (required for @crouton/auth)
  const teamFields = `  teamId: string
  owner: string
`

  // Build metadata fields conditionally
  const metadataFields = useMetadata ? `  createdAt: Date
  updatedAt: Date
  createdBy: string
  updatedBy: string
` : ''

  // Build the omit list for New${prefixedPascalCase} type
  const omitFields = ['id']
  if (useMetadata) {
    omitFields.push('createdAt', 'updatedAt', 'createdBy', 'updatedBy')
  }
  const omitList = omitFields.map(f => `'${f}'`).join(' | ')

  // Generate AI context header
  const aiHeader = generateAIHeader(data)

  return `${aiHeader}import type { z } from 'zod'
import type { ${prefixedSingular}Schema } from '${composablePath}'

export interface ${prefixedPascalCase} {
  id: string
${teamFields}  ${data.fieldsTypes}
${metadataFields}  optimisticId?: string
  optimisticAction?: 'create' | 'update' | 'delete'
}

export type ${prefixedPascalCase}FormData = z.infer<typeof ${prefixedSingular}Schema>
export type New${prefixedPascalCase} = Omit<${prefixedPascalCase}, ${omitList}>

// Props type for the Form component
export interface ${prefixedPascalCase}FormProps {
  items: string[] // Array of IDs for delete action
  activeItem: ${prefixedPascalCase} | Record<string, never> // ${prefixedPascalCase} for update, empty object for create
  collection: string
  loading: string
  action: 'create' | 'update' | 'delete'
}`
}
