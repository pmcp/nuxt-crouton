/**
 * Bridge to load TypeScript manifest-loader.ts from .mjs files.
 * Uses jiti for TypeScript → ESM interop.
 */

import { createJiti } from 'jiti'
import { fileURLToPath } from 'node:url'
import { dirname, join } from 'node:path'

const __dirname = dirname(fileURLToPath(import.meta.url))
const jiti = createJiti(__dirname, { interopDefault: true })

// Lazy-loaded module reference
let _loader: any = null

async function getLoader() {
  if (!_loader) {
    _loader = await jiti.import(join(__dirname, 'manifest-loader.ts'))
  }
  return _loader
}

export async function discoverManifests(rootDir?: string) {
  const loader = await getLoader()
  return loader.discoverManifests(rootDir)
}

export async function getTypeMapping(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getTypeMapping(manifests)
}

export async function getFieldTypeRegistry(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getFieldTypeRegistry(manifests)
}

export async function getCanonicalFieldTypes(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getCanonicalFieldTypes(manifests)
}

export async function getAutoGeneratedFields(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getAutoGeneratedFields(manifests)
}

export async function getReservedFieldNames(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getReservedFieldNames(manifests)
}

export async function getReservedCollectionNames(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getReservedCollectionNames(manifests)
}

export async function getModuleRegistry(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getModuleRegistry(manifests)
}

export async function getModuleRegistryMap(manifests: unknown[]) {
  const loader = await getLoader()
  return loader.getModuleRegistryMap(manifests)
}

export async function clearManifestCache() {
  const loader = await getLoader()
  return loader.clearManifestCache()
}

// ── Convenience helpers (discover + compute in one call) ──────────

export async function loadTypeMapping(rootDir?: string) {
  const loader = await getLoader()
  const manifests = await loader.discoverManifests(rootDir)
  return loader.getTypeMapping(manifests)
}

export async function loadModuleRegistryMap(rootDir?: string) {
  const loader = await getLoader()
  const manifests = await loader.discoverManifests(rootDir)
  return loader.getModuleRegistryMap(manifests)
}

export async function loadModuleRegistry(rootDir?: string) {
  const loader = await getLoader()
  const manifests = await loader.discoverManifests(rootDir)
  return loader.getModuleRegistry(manifests)
}
