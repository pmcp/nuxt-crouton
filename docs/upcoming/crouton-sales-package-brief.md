# Brief: Extract crouton-sales Package

**Created**: 2024-12-18
**Status**: In Progress (Phase 2 Complete)
**Owner**: TBD

---

## Executive Summary

Extract the POS/sales system from `crouton-sales` app into a reusable package `@friendlyinternet/crouton-sales` in the nuxt-crouton monorepo. The package supports event-based point-of-sale with products, categories, orders, and optional thermal receipt printing. Helper authentication will be migrated to `nuxt-crouton-auth` as part of this work.

---

## Quick Stats

| Metric | Value |
|--------|-------|
| Tasks | 10 / 16 completed |
| Phases | 5 |
| Priority | High |

---

## Decisions Made

| Decision | Choice |
|----------|--------|
| Package name | `@friendlyinternet/crouton-sales` |
| Table prefix | `sales` (expects `salesProducts`, `salesOrders`, etc.) |
| Print module | Opt-in via `croutonSales.print.enabled` config |
| Helper auth | Migrate to `nuxt-crouton-auth` as limited role |

---

## Task Tracker

### Phase 1: Package Foundation

- [x] **1.1** Create package skeleton at `/nuxt-crouton/packages/crouton-sales/`
  - package.json, nuxt.config.ts, build.config.ts
  - Follow pattern from `nuxt-crouton-supersaas`

- [x] **1.2** Copy schemas from `crouton-sales/schemas/` to package
  - event.json, product.json, category.json
  - order.json, orderItem.json
  - location.json, client.json, eventSettings.json

- [x] **1.3** Add print-related schemas (opt-in)
  - printer.json, printQueue.json
  - Only generated when print module enabled

### Phase 2: Core Business Logic

- [x] **2.1** Extract `usePosOrder.ts` composable
  - From: `layers/pos-views/app/composables/`
  - Handles: cart, checkout, price calculations

- [x] **2.2** Extract collection composables
  - SKIPPED: Collection composables are auto-generated by crouton CLI
  - Users generate them with `crouton config` into their `./layers/sales/` layer

- [x] **2.3** Create package API endpoints under `/api/sales/`
  - CRUD endpoints are auto-generated by crouton
  - Print server endpoints documented as examples (require DB access)

- [x] **2.4** Extract receipt formatter (opt-in)
  - From: `layers/pos/server/utils/receipt-formatter.ts`
  - From: `layers/pos/server/utils/print-queue-service.ts`
  - Only included when print module enabled

### Phase 3: Components

- [x] **3.1** Extract customer-facing components
  - Client/Cart.vue
  - Client/ProductList.vue
  - Client/CategoryTabs.vue
  - Client/ProductOptionsSelect.vue
  - Client/CartTotal.vue
  - Client/OrderInterface.vue
  - Client/Selector.vue
  - Client/OfflineBanner.vue

- [x] **3.2** Extract admin components
  - Admin/PosSidebar.vue
  - Pos/OrdersList.vue
  - Note: Collection CRUD components are auto-generated by crouton, not included in package

- [x] **3.3** Extract print settings components (opt-in)
  - Settings/ReceiptSettingsModal.vue
  - Settings/PrintPreviewModal.vue

### Phase 4: Helper Auth Migration

- [ ] **4.1** Extend nuxt-crouton-auth with "helper" role concept
  - Add `role: 'helper'` as limited access type
  - Add `scopedTo: { type: 'event', id: 'xxx' }` for event-specific access
  - Implement PIN as login method option

- [ ] **4.2** Migrate helper schema to auth package
  - Move `helpers` collection to auth or remove
  - Update login flow to use Better Auth session

- [ ] **4.3** Update crouton-sales to consume helper auth
  - Replace `useHelperAuth.ts` with auth package integration
  - Update middleware for helper route protection

### Phase 5: Integration & Testing

- [ ] **5.1** Update crouton-sales app to use package (dogfooding)
  - Replace duplicated code with package extends
  - Verify all functionality works
  - Test print module opt-in/opt-out

- [ ] **5.2** Documentation
  - README with setup instructions
  - Example crouton.config.mjs
  - Document print module configuration
  - Document helper auth integration

- [ ] **5.3** Final testing
  - All collection CRUD operations
  - Customer order flow
  - Print queue generation (if enabled)
  - Helper login flow

---

## Architecture

### Package Structure

```
nuxt-crouton/packages/crouton-sales/
├── package.json
├── nuxt.config.ts
├── module.ts
├── schemas/
│   ├── event.json
│   ├── product.json
│   ├── category.json
│   ├── order.json
│   ├── orderItem.json
│   ├── location.json
│   ├── client.json
│   ├── eventSettings.json
│   ├── printer.json        # opt-in
│   └── printQueue.json     # opt-in
├── app/
│   ├── composables/
│   │   ├── usePosOrder.ts
│   │   ├── usePosProducts.ts
│   │   ├── usePosCategories.ts
│   │   ├── usePosClients.ts
│   │   └── usePosEvents.ts
│   ├── components/
│   │   ├── Client/          # Customer order UI
│   │   ├── Admin/           # Admin sidebar
│   │   ├── Pos/             # Order management
│   │   └── Settings/        # Print settings (opt-in)
│   └── types/
├── server/
│   ├── api/sales/teams/[id]/
│   └── utils/
│       ├── receipt-formatter.ts    # opt-in
│       └── print-queue-service.ts  # opt-in
└── i18n/locales/
```

### Order Flow

```
Event → Products/Categories → Customer selects → Cart → Order → Print (opt-in)
```

1. Admin creates Event with Products organized by Categories
2. Customer (or Helper) opens order interface for event
3. Products displayed by category, options available
4. Items added to cart with quantities and remarks
5. Checkout creates Order with OrderItems
6. If printing enabled: Print jobs queued for locations

### Configuration

```ts
// User's nuxt.config.ts
export default defineNuxtConfig({
  extends: [
    '@friendlyinternet/nuxt-crouton',
    '@friendlyinternet/crouton-sales',
    './layers/sales'  // Generated layer
  ],
  croutonSales: {
    print: { enabled: true }  // Opt-in printing
  }
})
```

---

## User Workflow

1. **Install package**: `pnpm add @friendlyinternet/crouton-sales`
2. **Copy schemas**: From package to local `./schemas/`
3. **Configure crouton**: Use `sales` as layer name in crouton.config.mjs
4. **Generate**: `crouton config`
5. **Extend**: Add package to nuxt.config extends
6. **Done**: POS system ready

---

## Key Files to Extract

### From `layers/pos-views/app/composables/`
| File | Lines | Purpose |
|------|-------|---------|
| `usePosOrder.ts` | ~186 | Cart management, checkout, price calculations |
| `useHelperAuth.ts` | ~50 | Helper authentication (migrate to auth pkg) |

### From `layers/pos-views/app/components/`
| Directory | Files | Purpose |
|-----------|-------|---------|
| `Client/` | 8 | Customer order interface |
| `Admin/` | 1 | Admin sidebar navigation |
| `Pos/` | 1 | Order list management |
| `Settings/` | 2 | Print settings (opt-in) |

### From `layers/pos/server/utils/`
| File | Lines | Purpose |
|------|-------|---------|
| `receipt-formatter.ts` | ~334 | ESC/POS thermal receipt formatting |
| `print-queue-service.ts` | ~100 | Print job queuing |

---

## Convention Requirements

Package expects tables named:
- `salesEvents`
- `salesProducts`
- `salesCategories`
- `salesOrders`
- `salesOrderitems`
- `salesLocations`
- `salesClients`
- `salesEventsettings`
- `salesPrinters` (if print enabled)
- `salesPrintqueues` (if print enabled)

User MUST generate collections using `sales` as the layer name in crouton.config.mjs.

---

## Success Criteria

- [ ] User can install + generate + extend → working POS system
- [ ] Print module can be enabled/disabled without errors
- [ ] Helper auth works via nuxt-crouton-auth integration
- [ ] crouton-sales app uses package (no duplicated code)
- [ ] TypeScript types work correctly
- [ ] All existing functionality preserved

---

## Related Documents

- Similar package: `docs/briefings/crouton-bookings-package-brief.md`
- CLI docs: `/nuxt-crouton/packages/nuxt-crouton-cli/CLAUDE.md`
- Pattern reference: `/nuxt-crouton/packages/nuxt-crouton-supersaas/`

---

## Source Files Reference

```
/Users/pmcp/Projects/crouton-sales/
├── schemas/                    # 10+ schema JSON files
├── crouton.config.js           # Crouton configuration
├── layers/
│   ├── pos/                    # Generated collections
│   │   ├── collections/        # 10 collections
│   │   │   ├── products/
│   │   │   ├── categories/
│   │   │   ├── orders/
│   │   │   ├── orderitems/
│   │   │   ├── events/
│   │   │   ├── locations/
│   │   │   ├── clients/
│   │   │   ├── helpers/        # → migrate to auth
│   │   │   ├── printers/       # → opt-in
│   │   │   ├── printqueues/    # → opt-in
│   │   │   └── eventsettings/
│   │   └── server/utils/       # Receipt formatting
│   ├── pos-views/              # UI layer
│   │   ├── app/composables/    # usePosOrder, useHelperAuth
│   │   └── app/components/     # Client/, Admin/, Settings/, Pos/
│   └── crouton-events/         # Events CRUD (may merge with pos events)
```

---

## Notes for Agents

1. **Always run `npx nuxt typecheck`** after making changes
2. **Convention is critical**: Package imports assume `sales` layer name
3. **Print module is optional**: Check config before importing print utilities
4. **Helper auth is separate work**: Requires changes to nuxt-crouton-auth first
5. **Test by dogfooding**: Update crouton-sales app to use the package
6. **Events may overlap**: Coordinate with crouton-events if separate package exists

---

## Implementation Notes

### Print Module Opt-in Pattern
```ts
// In module.ts
if (options.print?.enabled) {
  // Register print composables
  // Include printer/printQueue schemas
  // Add receipt formatting utils
}
```

### Helper Auth in nuxt-crouton-auth
```ts
// Proposed extension to auth package
interface HelperRole {
  type: 'helper'
  scopedTo: {
    resourceType: 'event'
    resourceId: string
  }
  pin?: string  // Alternative to password
}
```
