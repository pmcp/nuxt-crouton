# Crouton CI ‚Äî Simplified Build Plan

## One-liner

Lightweight developer tooling for documentation checks, API tracking, cross-package commit hygiene, and release management.

---

## Quick Reference

| Item | Value |
|------|-------|
| Package | Scripts in `scripts/` (no separate package needed) |
| Status | Planning |
| Estimated effort | ~1.5 hours for core features |
| Related Plan | [PLAN-testing.md](./PLAN-testing.md) - Testing infrastructure |

---

## What Already Exists (Don't Rebuild)

| Feature | Status | Location | What It Does |
|---------|--------|----------|--------------|
| sync-check | ‚úÖ Done | `scripts/validate-field-types-sync.mjs` | Validates field types match across generator, MCP server, and skill file |
| CI workflow | ‚úÖ Done | `.github/workflows/ci.yml` | Lint, typecheck, sync validation, MCP tests |
| TypeScript API | ‚úÖ Auto | `packages/crouton/dist/module.d.ts` | Public API types (generated by unbuild) |
| Changelog data | ‚úÖ Done | `.github/workflows/sync-changelogs.yml` | Daily sync of external package changelogs |
| Audit skill | ‚úÖ Done | `.claude/skills/audit.md` | Manual package auditing via Claude |

### What `validate-field-types-sync.mjs` Does

This script already solves the "sync-check" problem:

```
Source of truth: Generator (packages/nuxt-crouton-cli/lib/utils/helpers.mjs)
                           ‚Üì
Compares against:   ‚îå‚îÄ MCP Server field types (field-types.ts)
                    ‚îî‚îÄ Claude Skill field types (crouton.md table)
                           ‚Üì
Output:            ‚úÖ All in sync  OR  ‚ùå Mismatch (exit code 1)
```

It runs in CI via the `sync-validation` job. **No need to rebuild this.**

---

## Problems to Solve

### 1. Documentation Drift
Package code changes but CLAUDE.md doesn't get updated.

### 2. Cross-Package Commit Hygiene
When working across multiple packages, commits become messy and hard to track.

### 3. API Stability (Public Module)
`@fyit/crouton` is now public. Accidental breaking changes need detection.

### 4. Release Process
No standardized changelog generation from commits.

### 5. Missing Tests
Packages have minimal test coverage (separate effort, noted here).

---

## What to Build

### Phase 1: Documentation Check Script

**File**: `scripts/check-docs.mjs`

```javascript
#!/usr/bin/env node
/**
 * Check that all packages have required documentation.
 * Exits 1 if any package is missing CLAUDE.md.
 */

import { readdirSync, existsSync } from 'node:fs'
import { join } from 'node:path'

const packagesDir = 'packages'
const required = ['CLAUDE.md']

let hasErrors = false

const packages = readdirSync(packagesDir, { withFileTypes: true })
  .filter(d => d.isDirectory())
  .filter(d => !d.name.startsWith('.'))
  .map(d => d.name)

console.log(`üìù Checking ${packages.length} packages for required docs...\n`)

for (const pkg of packages) {
  const pkgPath = join(packagesDir, pkg)
  const missing = required.filter(file => !existsSync(join(pkgPath, file)))

  if (missing.length > 0) {
    console.log(`‚ùå ${pkg}: missing ${missing.join(', ')}`)
    hasErrors = true
  } else {
    console.log(`‚úÖ ${pkg}`)
  }
}

console.log('')

if (hasErrors) {
  console.log('Documentation check failed.')
  process.exit(1)
} else {
  console.log('All packages have required documentation.')
  process.exit(0)
}
```

**Add to CI** (`.github/workflows/ci.yml`):

```yaml
docs-check:
  name: Documentation Check
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - name: Check docs exist
      run: node scripts/check-docs.mjs
```

**Time**: 15 minutes

---

### Phase 2: Cross-Package Commit Guidelines

**Problem**: When changes span multiple packages, it's unclear how to commit cleanly.

**Solution**: Document the convention. No tooling needed ‚Äî you'll internalize the pattern quickly.

#### Commit Strategy for Cross-Package Work

| Scenario | Strategy | Example |
|----------|----------|---------|
| Change affects 1 package | Standard commit | `feat(crouton-editor): add mobile support` |
| Change affects 2-3 related packages | Single commit with multi-scope | `feat(crouton-core,crouton-auth): add session refresh` |
| Change affects many packages | Split into logical commits | Commit per package, then a "sync" commit |
| Breaking change | Always separate commit | `feat(crouton)!: rename useEditor to useCroutonEditor` |

#### Monorepo Commit Format

```bash
<type>(<scope>): <description>

# Scopes (package short names):
# crouton, crouton-core, crouton-cli, crouton-auth, crouton-editor, etc.
# Use "root" for workspace-level changes

# Multi-package:
feat(crouton-core,crouton-cli): sync field validation

# Breaking change (add !):
feat(crouton)!: change CroutonOptions interface
```

**Time**: 15 minutes (just document in CLAUDE.md, already done)

---

### Phase 3: Changelog with changelogithub

**Goal**: Generate changelogs from conventional commits at release time.

**Setup**:

```bash
pnpm add -D changelogithub -w
```

Add to root `package.json`:

```json
{
  "scripts": {
    "changelog": "changelogithub"
  }
}
```

Create `changelogithub.config.ts`:

```typescript
export default {
  repo: 'pmcp/nuxt-crouton',
  capitalize: true,
  group: true,
  contributors: true,
  scopeMap: {
    'crouton': '@fyit/crouton',
    'crouton-core': '@fyit/crouton-core',
    'crouton-cli': '@fyit/crouton-cli',
    'crouton-auth': '@fyit/crouton-auth',
    'crouton-editor': '@fyit/crouton-editor',
    'crouton-i18n': '@fyit/crouton-i18n',
    'crouton-admin': '@fyit/crouton-admin',
    'crouton-ai': '@fyit/crouton-ai',
    'crouton-flow': '@fyit/crouton-flow',
    'crouton-collab': '@fyit/crouton-collab',
    'crouton-assets': '@fyit/crouton-assets',
    'crouton-maps': '@fyit/crouton-maps',
    'crouton-email': '@fyit/crouton-email',
    'crouton-events': '@fyit/crouton-events',
    'crouton-pages': '@fyit/crouton-pages',
    'crouton-devtools': '@fyit/crouton-devtools',
    'crouton-mcp-server': '@fyit/crouton-mcp-server',
    'crouton-themes': '@fyit/crouton-themes',
    'root': 'workspace'
  }
}
```

**Release workflow**:

```bash
# 1. Bump version
pnpm version patch  # or minor, major

# 2. Generate changelog and create GitHub release
pnpm changelog

# 3. Publish (when ready)
pnpm publish --filter @fyit/crouton
```

**Time**: 30 minutes

---

### Phase 4: Package Validation with publint + attw

**Goal**: Catch publishing mistakes before they reach npm.

**Why not api-extractor?** Your module's public API is ~16 boolean options. api-extractor is designed for libraries with hundreds of exports. For your use case, it's overkill and fights with Nuxt's type augmentation.

**What these tools catch:**

| Tool | What It Validates |
|------|-------------------|
| **publint** | package.json exports match actual built files |
| **attw** | TypeScript types resolve correctly for consumers |

**Setup**:

```bash
pnpm add -D publint @arethetypeswrong/cli -w
```

Add scripts to root `package.json`:

```json
{
  "scripts": {
    "check:package": "pnpm --filter @fyit/crouton build && publint packages/crouton && attw packages/crouton --pack"
  }
}
```

**What they catch (real examples)**:

```bash
# publint output when exports are wrong:
‚ùå pkg.exports["."].types points to non-existent file ./dist/module.d.ts

# attw output when types don't resolve:
‚ùå "CroutonOptions" is not exported from "@fyit/crouton"
```

**Add to CI**:

```yaml
package-check:
  name: Package Validity
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - uses: pnpm/action-setup@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
    - run: pnpm install --frozen-lockfile
    - run: pnpm --filter @fyit/crouton build
    - name: Validate package exports
      run: npx publint packages/crouton
    - name: Validate TypeScript types
      run: npx attw packages/crouton --pack
```

**For API changes**: Just review diffs to `packages/crouton/src/types.ts` in PRs. Your API is small enough that tooling is unnecessary.

**Time**: 20 minutes

---

## What NOT to Build

| Feature | Why Skip |
|---------|----------|
| Full `crouton-ci` package | Scripts are simpler, no build step |
| api-extractor | Overkill for 16-option API; fights with Nuxt types |
| Commit validation script | Warns but never blocks; you'll internalize the pattern |
| Provenance tracking (`<!-- human-written -->`) | Gets stale, bureaucratic |
| Freshness scores (A/B/C grades) | Vanity metrics |
| Interactive modes | Use `/audit` skill instead |
| impact-check | Read changelogs manually |
| test-examples | High maintenance |
| init-hooks (pre-commit) | CI enforcement is better |
| Weekly auto-issues | Becomes noise |

---

## Testing

See **[PLAN-testing.md](./PLAN-testing.md)** for the complete testing strategy.

**Summary**: The monorepo has ~60 existing tests across 8 packages (more than originally thought). The testing plan covers:
- Fixing CI to run all existing tests (Phase 1)
- Adopting `@nuxt/test-utils` per Nuxt 4 best practices (Phase 1.5)
- Adding CLI generator tests (Phase 2)
- Auth integration tests (Phase 3)
- Core API tests (Phase 4)
- E2E smoke tests (Phase 5)

The CI workflow in this plan assumes tests are configured per PLAN-testing.md.

---

## Final Architecture

```
scripts/
‚îú‚îÄ‚îÄ check-docs.mjs                  # CI: verify CLAUDE.md exists (NEW)
‚îî‚îÄ‚îÄ validate-field-types-sync.mjs   # CI: verify field types sync (EXISTS)

.github/workflows/
‚îú‚îÄ‚îÄ ci.yml                          # Lint, typecheck, docs, sync, package (UPDATE)
‚îî‚îÄ‚îÄ sync-changelogs.yml             # Daily changelog sync (EXISTS)

.claude/skills/
‚îî‚îÄ‚îÄ audit.md                        # Manual audit via Claude (EXISTS)

changelogithub.config.ts            # Changelog generation config (NEW)
```

---

## Implementation Order

| Phase | What | Time | Priority |
|-------|------|------|----------|
| 1 | `check-docs.mjs` + CI job | 15 min | High |
| 2 | Cross-package commit guidelines (docs only) | 15 min | High |
| 3 | changelogithub setup | 30 min | High |
| 4 | publint + attw + CI job | 20 min | High |
| - | Testing infrastructure | Separate plan | High |

**Total time**: ~1.5 hours for Phases 1-4

---

## Success Criteria

- [ ] CI fails if any package is missing CLAUDE.md
- [ ] Clear guidelines exist for cross-package commits (in CLAUDE.md)
- [ ] `pnpm changelog` generates release notes from commits
- [ ] CI fails if package.json exports don't match built files (publint)
- [ ] CI fails if TypeScript types don't resolve correctly (attw)
- [ ] Field types stay in sync (already working)

---

## Answers to Your Questions

### Why publint and attw instead of api-extractor?

api-extractor is designed for large TypeScript libraries with hundreds of exports. Your module has ~16 boolean options. The tools have different purposes:

| Tool | Purpose | Your Need |
|------|---------|-----------|
| api-extractor | Track API changes in large libraries | ‚ùå Overkill |
| publint | Verify package.json exports are valid | ‚úÖ Catches publishing mistakes |
| attw | Verify TypeScript types resolve | ‚úÖ Catches broken types |

For API changes, just review diffs to `packages/crouton/src/types.ts` in PRs.

### Is testing included in this plan?

**No.** The original plan was only about documentation tooling. Testing is a separate effort and should have its own plan.

### What does validate-field-types-sync.mjs do?

It ensures three places stay in sync:

| Source | Location | Contains |
|--------|----------|----------|
| Generator (truth) | `packages/crouton-cli/lib/utils/helpers.mjs` | Field type definitions |
| MCP Server | `packages/crouton-mcp/src/utils/field-types.ts` | Same types for AI tools |
| Claude Skill | `.claude/skills/crouton.md` | Table of field types |

If you add a new field type to the generator but forget to update the MCP server or skill, CI fails.

### How does the new module affect things?

`packages/crouton` is a proper Nuxt module that:
1. Generates TypeScript declarations (`dist/module.d.ts`)
2. Exposes `CroutonOptions` interface as public API
3. Is published to npm as `@fyit/crouton`

This means:
- **API stability matters** ‚Äî external users depend on your types
- **publint/attw catch publishing mistakes** ‚Äî broken exports or types
- **Breaking changes need marking** ‚Äî use `!` in commits: `feat(crouton)!: change API`
